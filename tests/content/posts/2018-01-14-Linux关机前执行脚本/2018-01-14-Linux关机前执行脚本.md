Title: Linux关机前执行脚本
Date: 2018-01-14 11:01:54
Modified: 2018-01-14 11:01:55
Slug: Linux_execution_script_before_shutdown
Tags: linux, bash
Author: Xiaojie Luo
----------

想让 Linux 在关机之前执行一些脚本， 是想执行一些清理保存工作， 免得数据丢失。下面整理了两种关机前执行脚本的方法。

## 一、使用 `service` 管理系统的
如果是使用 `service` 管理系统的， 例如 centos 6 系列， 首先把脚本的权限提升到可执行：

```shell
sudo chmod +x bash.sh

```

然后再复制到 `/etc/rc0.d/` 文件夹中：
```
sudo cp bash.sh /etc/rc0.d/
```

注：
* `rc0.d` 存放的是关机执行的脚本
* `rc6.d` 存放的是重启执行的脚本

## 二、使用 `systemctl` 管理系统的
如果是使用 `systemctl` 管理系统的， 可以在 `/usr/lib/systemd/system-shutdown` 目录中添加一个脚本, [systemd-halt.service](https://www.freedesktop.org/software/systemd/man/systemd-halt.service.html) 会处理这个目录中的脚本。

Example:
    ```shell
    sudo vim /lib/systemd/system-shutdown/cleanup.service
    ```
编辑内容如下：
```shell
[Unit]
Description=Run command at shutdown
# 假设要执行的命令依赖网络
Requires=network.target
DefaultDependencies=no
Before=shutdown.target reboot.target

[Service]
Type=oneshot
RemainAfterExit=true
ExecStart=/bin/true
ExecStop=<要执行的命令>

[Install]
WantedBy=multi-user.target
```
